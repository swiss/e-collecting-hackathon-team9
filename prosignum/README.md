# Prosignum - Swiss E-Collecting Platform

Secure, federated signature collection system for Swiss e-democracy with Swiyu E-ID authentication.

**Developed by Papers AG**

## Overview

Prosignum is a Django-based referendum signature collection platform that allows:
- Citizens to sign initiatives using their Swiss E-ID (Swiyu)
- Municipality-based review and verification of signatures
- Initiative creators to view aggregated statistics
- Secure, privacy-preserving signature management

## Features

- ğŸ‡¨ğŸ‡­ **Swiyu E-ID Authentication** - QR code-based authentication using Swiss digital identity
- âœï¸ **Digital Signatures** - Collect referendum signatures with identity verification
- ğŸ›ï¸ **Municipality Review** - Permission-based signature review by municipality
- ğŸ“Š **Privacy-Preserving Statistics** - Aggregated totals only, individual signatures protected
- ğŸ”’ **Permission System** - Role-based access control for creators and reviewers
- ğŸ—‚ï¸ **2,127 Swiss Municipalities** - Complete Swiss municipality database

## Tech Stack

- **Backend:** Django 5.2.7 (Python 3.12)
- **Database:** PostgreSQL 15
- **Authentication:** Swiyu OpenID4VP verifier
- **Admin UI:** Django Unfold
- **Containerization:** Docker Compose
- **Identity:** Decentralized Identifiers (DID:TDW)

## Prerequisites

- Docker & Docker Compose
- Java 21+ (for DID generation)
- Swiyu API credentials (see setup below)
- Public URL with Cloudflare tunnel or similar (for mobile app access)

## Initial Setup

### 1. Clone and Navigate

```bash
cd prosignum
```

### 2. Get Swiyu API Credentials

1. **Register on ePortal:**
   - Visit: https://eportal.admin.ch/start
   - Login with AGOV or CH-Login
   - Search for "swiyu Trust Infrastructure"
   - Register your organization â†’ Save your **Partner ID**

2. **Subscribe to APIs:**
   - Visit: http://selfservice.api.admin.ch/api-selfservice
   - Subscribe to **"swiyucorebusiness_identifier"** API
   - Create application
   - Save: **Client ID**, **Client Secret**, **Refresh Token**

### 3. Generate Swiyu DID

Run the automated setup script:

```bash
../setup-swiyu-did.sh
```

This will prompt you for:
- Refresh Token, Client ID, Client Secret, Partner ID
- External URL (e.g., `https://swiyu.yourdomain.com`)
- Verifier Name (e.g., "My Application")

The script will:
- Generate cryptographic keys
- Create and upload your DID to Swiyu registry
- Update `.env` configuration

### 4. Create Production Override File

The `docker-compose.yml` contains a **placeholder key** for security. Create the production override:

```bash
# Copy the template
cp docker-compose.prod.yml.sample docker-compose.prod.yml

# Edit and paste your actual signing key from did-keys/signing-key.pem
# The file should look like:
# services:
#   verifier-service:
#     environment:
#       SIGNING_KEY: |
#         -----BEGIN EC PRIVATE KEY-----
#         [paste your actual key here]
#         -----END EC PRIVATE KEY-----
```

**Important:** `docker-compose.prod.yml` is gitignored and contains your private key. Never commit it!

### 5. Configure Environment

Create or verify your `.env` file in the project root contains:

```env
# Swiyu API Credentials
SWIYU_ACCESS_TOKEN=your_access_token
SWIYU_REFRESH_TOKEN=your_refresh_token
SWIYU_CUSTOMER_KEY=your_client_id
SWIYU_CUSTOMER_SECRET=your_client_secret
SWIYU_PARTNER_ID=your_partner_id

# DID Configuration (auto-generated by setup script)
VERIFIER_DID=did:tdw:...
DID_VERIFICATION_METHOD=did:tdw:...#assert-key-01
VERIFIER_NAME=Your App Name
SIGNING_KEY=-----BEGIN EC PRIVATE KEY-----...

# External URLs
EXTERNAL_URL=https://swiyu.yourdomain.com
DJANGO_URL=https://app.yourdomain.com

# Database
POSTGRES_DB=swiyu_verifier
POSTGRES_USER=postgres
POSTGRES_PASSWORD=your_secure_password
POSTGRES_HOST=postgres
POSTGRES_PORT=5432

DJANGO_DB_NAME=prosignum
DJANGO_DB_USER=postgres
DJANGO_DB_PASSWORD=your_secure_password
DJANGO_DB_HOST=postgres
DJANGO_DB_PORT=5432

# Django
DJANGO_SECRET_KEY=your_django_secret_key
DEBUG=True
ALLOWED_HOSTS=app.yourdomain.com,localhost,127.0.0.1
CSRF_TRUSTED_ORIGINS=https://app.yourdomain.com,https://swiyu.yourdomain.com

# Verifier API
SWIYU_VERIFIER_API_URL=http://verifier-service:8080
SWIYU_VERIFICATION_TIMEOUT=300
SWIYU_POLL_INTERVAL=2
```

### 5. Set Up Cloudflare Tunnels

Configure two tunnels pointing to your machine:

1. **Swiyu Verifier** (for mobile app):
   - `swiyu.yourdomain.com` â†’ `http://localhost:8080`

2. **Django Application** (web interface):
   - `app.yourdomain.com` â†’ `http://localhost:8000`

### 6. Start Services

```bash
cd ..  # Back to project root

# Build Django image
docker compose build

# Start all services (includes prod override with your actual signing key)
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

Wait ~75 seconds for all services to start.

**Note:** Always use both compose files (`-f docker-compose.yml -f docker-compose.prod.yml`) to include your production signing key.

### 7. Verify Setup

Check all services are running:

```bash
docker compose ps
```

You should see:
- `postgres` (healthy)
- `verifier-service` (running on port 8080)
- `django` (running on port 8000)

Check logs:

```bash
docker compose logs verifier-service | grep "Started Application"
docker compose logs django | tail -20
```

## Usage

### Access Points

- **Homepage:** https://app.yourdomain.com (or http://localhost:8000)
- **Admin Panel:** https://app.yourdomain.com/admin/
- **Swiyu Login:** https://app.yourdomain.com/swiyu/login/
- **Verifier API:** http://localhost:8080/swagger-ui.html (local only)

### Authentication Flow

1. User visits `/swiyu/login/`
2. QR code is displayed
3. User scans with Swiyu mobile app
4. App validates verifier DID and shows approval screen
5. User approves â†’ authenticated
6. User data (name, birth date, birth place) available in session

### Create a Superuser

```bash
docker compose exec django python manage.py createsuperuser
```

### Permission Groups

The system uses Django groups for permissions:

1. **Initiative Creators**
   - Permission: `can_create_initiative`
   - Can create initiatives
   - Can view their own initiatives
   - Can see aggregated signature totals per municipality

2. **Municipality Reviewers** (e.g., "Municipality_ZÃ¼rich_Reviewers")
   - Permission: `can_review_signatures`
   - Can view signatures only from their municipality
   - Can accept/reject pending signatures
   - Admin actions: Accept/Reject selected signatures

Create groups in Django admin and assign users to them.

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Internet/Cloudflare               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                      â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Django App    â”‚    â”‚  Swiyu Verifier   â”‚
    â”‚  Port 8000     â”‚    â”‚  Port 8080        â”‚
    â”‚                â”‚    â”‚  (Mobile app      â”‚
    â”‚  - Web UI      â”‚â”€â”€â”€â–¶â”‚   communicates)   â”‚
    â”‚  - Admin       â”‚    â”‚                   â”‚
    â”‚  - QR Display  â”‚    â”‚  - DID:TDW        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  - OpenID4VP      â”‚
            â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                     â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚       PostgreSQL Database          â”‚
    â”‚   - prosignum (Django)             â”‚
    â”‚   - swiyu_verifier (Verifier)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Database Models

### Swiyu App

- **SwiyuVerification**: Tracks verification requests (QR codes)
- **SwiyuUserProfile**: Stores verified E-ID claims

### Core App

- **Municipality**: Swiss municipalities (2,127 imported from BFS data)
- **Initiative**: Referendum/initiative with creator and status
- **Participant**: Citizens linked to Swiyu profiles
- **Signature**: Links participant to initiative with review status
  - Status: PENDING, ACCEPTED, REJECTED
  - Unique constraint: one signature per participant per initiative

## Development

### Local Development (without Docker)

```bash
# Create virtual environment
python3.12 -m venv venv
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Run migrations
python manage.py migrate

# Import municipalities
python manage.py import_municipalities ../AMTOVZ_CSV_LV95.csv

# Create superuser
python manage.py createsuperuser

# Run development server
python manage.py runserver
```

**Note:** For Swiyu authentication to work, you still need the verifier-service running via Docker.

### Running Tests

```bash
docker compose exec django python manage.py test
```

### Database Migrations

```bash
# Create migrations
docker compose exec django python manage.py makemigrations

# Apply migrations
docker compose exec django python manage.py migrate
```

## Troubleshooting

### Swiyu App Shows "Invalid Check"

**Problem:** Mobile app rejects QR code with "invalid check" error.

**Solutions:**
1. Ensure Cloudflare tunnel is running and points to port 8080
2. Verify DID was uploaded: check `did-keys/didlog.jsonl` exists
3. Confirm EXTERNAL_URL in `.env` matches your Cloudflare tunnel domain
4. Check verifier logs: `docker compose logs verifier-service`
5. Verify DID format includes full path: `...identifier-reg.trust-infra.swiyu-int.admin.ch:api:v1:did:{UUID}`

### Verifier Service Won't Start

**Problem:** Container keeps restarting.

**Solutions:**
1. Check logs: `docker compose logs verifier-service`
2. Verify SIGNING_KEY in .env matches public key in DID document
3. Ensure DID_VERIFICATION_METHOD ends with `#assert-key-01`
4. Check database is healthy: `docker compose ps postgres`

### Django Can't Connect to Database

**Problem:** `OperationalError: database "prosignum" does not exist`

**Solution:**
```bash
docker compose exec postgres psql -U postgres -c "CREATE DATABASE prosignum;"
docker compose restart django
```

## Security Considerations

### DO NOT Commit to Git:

- `.env` file (contains secrets and private keys)
- `did-keys/signing-key.pem` (your private key!)
- `did-keys/.didtoolbox/` directory (contains sensitive keys)

### Production Checklist:

- [ ] Change all default passwords
- [ ] Set `DEBUG=False` in production
- [ ] Use strong `DJANGO_SECRET_KEY`
- [ ] Enable HTTPS only
- [ ] Restrict `ALLOWED_HOSTS`
- [ ] Use environment-specific `.env` files
- [ ] Back up `did-keys/` directory securely
- [ ] Implement rate limiting on authentication endpoints
- [ ] Set up monitoring and logging
- [ ] Regular security updates

## License

This software is licensed under a AGPL 3.0 License - see the [LICENSE](../LICENSE) file for details. Please feel free to [choose any other](https://choosealicense.com/) [Open Source Initiative approved license](https://opensource.org/licenses) (e.g. a permissive license such as [MIT](https://opensource.org/license/mit)). Other content (e.g. text, images, etc.) is licensed under a [Creative Commons CC BY-SA 4.0 license](https://creativecommons.org/licenses/by-sa/4.0/deed.de). Exceptions are possible in consultation with the organizers.

**Copyright Â© 2025 Papers AG. All rights reserved.**

## Acknowledgments

- Developed by **Papers AG** for e-Collecting Hackathon 2025
- Uses Swiyu Public Beta Trust Infrastructure
- Powered by Swiss Confederation's E-ID system

## Support

For Swiyu-specific issues, consult:
- Documentation: https://swiyu-admin-ch.github.io/
- Community: https://github.com/swiyu-admin-ch/community

For Prosignum issues, contact Papers AG.
