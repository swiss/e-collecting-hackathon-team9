{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{% trans "Login with Swiss E-ID" %}{% endblock %}

{% block meta_description %}{% trans "Authenticate using your Swiss E-ID to access the platform" %}{% endblock %}

{% block extra_css %}
<style>
    .qr-container {
        margin: var(--spacing-xl) auto;
        padding: var(--spacing-lg);
        border: 2px solid var(--ch-gray-light);
        border-radius: 0;
        display: inline-block;
        background: var(--ch-white);
        text-align: center;
    }
    .qr-container img {
        display: block;
        margin: 0 auto;
    }
    .status {
        margin-top: var(--spacing-lg);
        font-size: var(--font-size-large);
        padding: var(--spacing-md);
        border-radius: 0;
    }
    .status.pending {
        background-color: #FFF4E6;
        border-left: 4px solid var(--ch-warning);
    }
    .status.completed {
        background-color: #E6F7ED;
        border-left: 4px solid var(--ch-success);
    }
    .status.failed, .status.expired {
        background-color: #FFE6E6;
        border-left: 4px solid var(--ch-error);
    }
    .spinner {
        border: 4px solid var(--ch-gray-light);
        border-top: 4px solid var(--ch-blue-primary);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: var(--spacing-lg) auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .login-content {
        text-align: center;
        max-width: 600px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="login-content">
    <h1>{% trans "Login with Swiss E-ID" %}</h1>
    <p style="color: var(--ch-gray-medium); font-size: var(--font-size-large); margin-bottom: var(--spacing-lg);">
        {% trans "Scan the QR code below with your Swiyu wallet app" %}
    </p>

    <div class="ch-alert ch-alert-info" role="alert" aria-live="polite" style="text-align: left; max-width: 500px; margin: var(--spacing-lg) auto;">
        <div class="ch-alert-title">{% trans "Instructions" %}:</div>
        <div class="ch-alert-message">
            <ol style="margin: var(--spacing-sm) 0; padding-left: var(--spacing-lg);">
                <li style="margin-bottom: var(--spacing-xs);">{% trans "Open your Swiyu wallet app on your smartphone" %}</li>
                <li style="margin-bottom: var(--spacing-xs);">{% trans "Scan the QR code below" %}</li>
                <li>{% trans "Approve the authentication request in the app" %}</li>
            </ol>
        </div>
    </div>

    <div class="qr-container">
        <img src="data:image/png;base64,{{ qr_code }}" alt="{% trans 'QR Code for authentication' %}" />
    </div>

    <div class="status pending" id="status" role="status" aria-live="polite">
        <div class="spinner" aria-label="{% trans 'Loading' %}"></div>
        <p>{% trans "Waiting for you to scan the QR code..." %}</p>
    </div>

    <p style="color: var(--ch-gray-medium); font-size: var(--font-size-small); margin-top: var(--spacing-lg);">
        <small>{% trans "QR code expires in" %} {{ expires_in }} {% trans "seconds" %}</small><br>
        <small>({% trans "For testing: Auto-completes after 5 seconds with mock data" %})</small>
    </p>

    <div style="margin-top: var(--spacing-xl);">
        {% include 'components/button.html' with text=_("Back to Home") url="/" type="secondary" %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const verificationId = "{{ verification_id }}";
    const pollInterval = {{ poll_interval }} * 1000;

    function checkStatus() {
        fetch(`/swiyu/status/${verificationId}/`)
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('status');

                if (data.status === 'completed') {
                    statusDiv.className = 'status completed';
                    statusDiv.innerHTML = '<p>✓ {% trans "Authentication successful! Redirecting..." %}</p>';
                    setTimeout(() => {
                        window.location.href = data.redirect;
                    }, 1000);
                } else if (data.status === 'failed') {
                    statusDiv.className = 'status failed';
                    statusDiv.innerHTML = `<p>✗ {% trans "Authentication failed:" %} ${data.error || '{% trans "Unknown error" %}'}</p>`;
                } else if (data.status === 'expired') {
                    statusDiv.className = 'status expired';
                    statusDiv.innerHTML = '<p>✗ {% trans "QR code expired. Please" %} <a href="/swiyu/login/">{% trans "refresh" %}</a> {% trans "to try again." %}</p>';
                } else {
                    // Still pending, continue polling
                    setTimeout(checkStatus, pollInterval);
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                setTimeout(checkStatus, pollInterval);
            });
    }

    // Start polling
    setTimeout(checkStatus, pollInterval);
</script>
{% endblock %}
